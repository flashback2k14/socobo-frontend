<!--
The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--socobo-recipe-style-action-btn-color` | Background color of the action buttons | --accent-color

@demo demo/socobo-inventory/demo.html
-->

<dom-module id="socobo-inventory">
  <template>
    <style>
      :host {
        display: block;
      }

      .button-add {
        position: fixed;
        top: 36px;
        right: 80px;
      }
    </style>
    <div>
      <socobo-inventory-create
        id="inventoryCreateDialog"
        on-create-item="_onCreateItem"
        measurements="[[measurements]]">
      </socobo-inventory-create>
      <socobo-inventory-edit
        id="inventoryEditDialog"
        on-edit-item="_saveItem"
        measurements="[[measurements]]">
      </socobo-inventory-edit>

      <firebase-collection
        id="inventoryCollection"
        order-by-child="created"
        location="{{location}}"
        data="{{data}}">
      </firebase-collection>
      <firebase-collection
        id="measurementCollection"
        order-by-child="name"
        location="{{measurementLocation}}"
        data="{{measurements}}">
      </firebase-collection>

      <socobo-inventory-overview
        id="inventoryOverview"
        on-edit_request="_editItem"
        on-delete_request="_confirmDelete"
        on-check = "_handleCheck"
        on-uncheck = "_handleUncheck"
        on-checked-all = "_handleCheckAll"
        data="[[data]]">
      </socobo-inventory-overview>
    <socobo-element-buttons
      class="button-add"
      show-delete="{{_itemsChecked}}"
      on-add-item="_createItem"
      on-delete-item="_deleteAllItems">
    </socobo-element-buttons>
    </div>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'socobo-inventory',

        properties: {

          /*Object containing the user information. Must have following
          properties:
          - userId,
          - firebaseUrl,
          - expires
          */
          userLogin: {
            type: Object
          },

          /*Specifies the location of the Firebase database
          */
          location: {
            computed: "_handleLogin(userLogin)",
            type: String,
            value: "https://socobo.firebaseio.com/"
          },

          measurementLocation: {
            computed: "_handleMeasurement(userLogin)",
            type: String,
            value: "https://socobo.firebaseio.com/"
          }
        },

        ready: function () {
          this._checkedItems = 0;
          this._itemsChecked = false;
        },

        _handleMeasurement: function(login){
          return login ? login.firebaseUrl + "measurements/" : this.measurementLocation;
        },

        /*Construct firebase url for user's inventory from userLogin object</br>
         @param {Object} login
         @method _handleLogin
         */
        _handleLogin: function(login) {
          var url = "";
          if (login) {
            url = login.firebaseUrl + "inventory/";
            url = login.userId ? url + login.userId + "/" : url
          } else {
            url = this.location;
          }
          return url;
        },

        _handleCheckAll: function (e) {
          this._checkedItems = 0;
          this._itemsChecked = e.detail.state;

          if (e.detail.state) {
            this._checkedItems = e.detail.number;
          }
        },

        _handleCheck: function (e) {
          this._checkedItems++;
          this._itemsChecked = this._checkedItems !== 0;
        },

        _handleUncheck: function (e) {
          this._checkedItems--;
          this._itemsChecked = this._checkedItems !== 0
        },

        /*Display dialog to create new inventory items
        */
        _createItem: function () {
          this.$.inventoryCreateDialog.show();
        },

        _onCreateItem: function(e) {
          var item = e.detail;
          item.created = Firebase.ServerValue.TIMESTAMP;

          this.$.inventoryCollection.add(item);
          this.$.inventoryCreateDialog.hide();
        },
        /**
         * Handler for the delete_request event fired by the corresponding
         * socobo-element-list-item. Deletes this item from the database.
         * @param {Event} e
         */
        _confirmDelete: function(e) {
          this.$.inventoryCollection.remove(e.detail);
        },

        /* Display dialog to edit inventory items
        */
        _editItem: function(e) {
          this.$.inventoryEditDialog.show(e.detail);
        },

        _deleteAllItems: function (e) {
          var itemList = this.querySelectorAll(".inventory-list-item");
          for (var i in itemList) {
            var element = itemList[i];
            if (!element.hidden && element.isChecked) {
              this.$.inventoryCollection.removeByKey(element.obj.__firebaseKey__)
            }
          }
          this._checkedItems = 0;
          this._itemsChecked = false;
          this.$.inventoryOverview.resetSearch();
        },

        /* Save changes made to inventory items
        */
        _saveItem: function(e) {
          var item = e.detail;
          var self = this;
          if (item.__firebaseKey__) {
            var ref = new Firebase(this._handleLogin(this.userLogin) + "/" + item.__firebaseKey__);
            ref.update(item, function(error) {
              if (error) {
                alert("There was an error updating the item");
                console.log(error);
              } else {
                self.$.inventoryEditDialog.hide();
              }
            });
          }
        }
      });
    })();
  </script>
</dom-module>
